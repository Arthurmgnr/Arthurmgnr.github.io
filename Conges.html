<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendrier des Congés</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"/>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background-color: #C9C9C9; }
        .header { display: flex; align-items: center; justify-content: space-evenly; margin-top: 20px; }
        h1 { color: #227D48; margin: 0; }
        .year-container { display: flex; align-items: center; gap: 1rem; }
        .year { all: inherit; }
        #year { font-size: inherit; background-color: inherit; font-weight: inherit; color: inherit; min-width: 8rem; max-width: 8rem; text-align: center; }
        .calendar-container { display: grid; grid-template-columns: repeat(12, 1fr); width: 90%; gap: 10px; margin: 20px auto; }
        .month-title { font-weight: bold; font-size: large; padding: 10px 0; background-color: #227D48; color: #fff; }
        .day { display: flex; justify-content: flex-start; border-bottom: 1px solid #ddd; background-color: #fff; align-items: center; }
        .weekend { background-color: #D3F9D8; }
        .holiday { background-color: #F5B084; }
        .dayTable { border-collapse: collapse; width: 100%; }
        .dayTable tr { min-height: 1.5rem; max-height: 1.5rem; }
        .dayTable td:nth-child(1) { width: 20%; }
        .dayTable td:nth-child(2) { width: 20%; }
        .dayTable td:nth-child(3) { width: 60%; }

        .summary { margin-top: 50px; margin-bottom: 50vh; }
        .congesSummary { font-size: x-large; margin: 20px auto; width: fit-content; border: none; border-collapse: collapse; }
        .congesSummary th, .congesSummary td { padding: 20px; border: solid 1px; }
        .congesSummary th.noBorder, .congesSummary td.noBorder { border: none; }
        input[id^="total"] { font-size: inherit; background-color: inherit; min-width: 4rem; max-width: 4rem; text-align: center; }
        .congesSummary input[type="text"] { font-size: inherit; text-align: center; background-color: inherit; }
        .noBorder { display: flex; gap: 10px; }
        input[type="color"] { width: 30px; height: 30px; border: none; background: none; padding: 0; cursor: pointer; vertical-align: middle; appearance: none; -webkit-appearance: none; -moz-appearance: none; }

        .saveConge { width: 50%; margin: 20px auto; display: flex; justify-content: space-evenly; }
        
        .selection { width: 90%; display: flex; margin: 20px auto; justify-content: space-evenly; }
        .selectionConge { font-size: x-large; font-weight: bold; cursor: pointer; padding: 10px 15px; border-radius: 0.75rem; }

        i.material-icons { font-weight: bold; }

        button:not(.modal-button, .toast-button) { padding: 10px 15px; margin: 0 auto; border: none; cursor: pointer; border-radius: 0.75rem; display: flex; align-items: center; gap: 0.5rem; font-size: large; font-weight: bold; }
        .save { background-color: #4CAF50; color: white; }
        .delete { background-color: #f44336; color: white; }
        .delete-category { background-color: #ff9800; color: white; }
        .edit-category { background-color: #2196F3; color: white; }
        .delete-category-days { background-color: #9C27B0; color: white; }
        .add-category { background-color: #8BC34A; color: white; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.3); justify-content: center; align-items: center; }
        .modal-content { width: 60%; background: white; padding: 20px; border-radius: 1.5rem; text-align: center; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.3); font-size: large; }
        .modal-button-container { display: flex; justify-content: space-around; }/* padding: 20px ; border-top: solid 1px gray; }*/
        .modal-button-group-right { display: flex; }
        .modal-button { margin: 10px; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: inherit; }
        .md-not-save { background-color: rgb(220, 53, 69); color: white; }
        .md-not-save:hover { background-color: rgb(187, 45, 59); }
        .md-cancel { background-color: rgb(108, 117, 125); color: black; }
        .md-cancel:hover { background-color: rgb(92, 99, 106); }
        .md-save { background-color: rgb(13, 110, 253); color: white; }
        .md-save:hover { background-color: rgb(8, 94, 215); }

        .wrapper { width: fit-content; position: fixed; bottom: 10px; right: 10px; display: flex; flex-direction: column-reverse; gap: 10px; z-index: 1000; align-items: flex-end; }
        .toast { width: fit-content; padding: 10px; background-color: #ffffff; border-radius: 7px; display: flex; box-shadow: 0 15px 30px rgba(0,0,0,0.08); }
        .success { border-left: 8px solid #47D764; }
        .error { border-left: 8px solid #ff355b; }
        .info { border-left: 8px solid #2F86EB; }
        .warning { border-left: 8px solid #FFC021; }
        .error span { color: #ff355b; }
        .info span { color: #2F86EB; }
        .warning span { color: #FFC021; }
        .container-1, .container-2 { align-self: center; }
        .container-1 { padding: 0 18px 0 10px; }
        .container-2 { text-align: left; }
        .container-1 span { font-size: 35px; }
        .success span { color: #47D764; }
        .container-2 p:first-child { color: #101020; font-weight: bold; font-size: x-large; }
        .container-2 p:last-child { color: #656565; font-size: large; }
        .toast-button { border: none; margin: 0 auto; padding: 10px 15px; align-self: flex-start; background-color: transparent; font-size: x-large; color: #656565; line-height: 0; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">
        <div class="title-container">
            <h1>Calendrier des Congés</h1>
        </div>
        <div class="year-container">
            <h1><label class="year" for="year">Année</label></h1>
            <h1><input type="number" id="year" min="2000" max="2100" onchange="changeYearValue()" onfocus="storeOldValue(this)"></h1>
        </div>
    </div>

    <div class="saveConge">
        <button class="save" onclick="saveYear()" title="Sauvegarder les données de l'année en cours">
            <span class="material-symbols-outlined">save</span>Enregistrer
        </button>
        <button class="delete" onclick="deleteYear()" title="Supprimer les jours de congés posés dans le calendrier de l'année en cours">
            <span class="material-symbols-outlined">delete</span>Supprimer
        </button>
    </div>

    <div class="selection"></div>
    
    <div id="calendar" class="calendar-container"></div>
    
    <div class="summary">
        <h1>Résumé des Congés</h1>
        <table class="congesSummary" border="1" width="50%" align="center">
            <tbody>
                <tr>
                    <td class="noBorder"></td>
                    <th>Catégorie</th>
                    <th>Nombre possibles</th>
                    <th>Nombre posés</th>
                    <th>Nombre restants</th>
                </tr>
                <tr>
                    <td class="noBorder"></td>
                    <th>Total</th>
                    <td id="totalAll">0</td>
                    <td id="usedAll">0</td>
                    <td id="remainingAll">0</td>
                </tr>
            </tbody>
        </table>
        <button class="add-category" onclick="addCategory()" title="Ajouter une catégorie supplémentaire">
            <span class="material-symbols-outlined">add_circle</span>Catégorie
        </button>
    </div>

    <div id="customConfirm" class="modal">
        <div class="modal-content">
            <div class="modal-title">
                <h2>Souhaitez-vous enregistrer vos modifications ?</h2>
                <p>Vous pouvez choisir d’enregistrer vos modifications ou non. Vous ne pouvez pas annuler cette action.</p>
                <p>Toute modification non enregistrée sera perdue.</p>
            </div>
            <div class="modal-button-container">
                <div class="modal-button-group-left">
                    <button class="modal-button md-not-save" onclick="confirmSave(false)">Ne pas enregistrer</button>
                </div>
                <div class="modal-button-group-right">
                    <button class="modal-button md-cancel" onclick="confirmSave(false)">Annuler</button>
                    <button class="modal-button md-save" onclick="confirmSave(true)">Enregister</button>
                </div>
            </div>
        </div>
    </div>

    <div class="wrapper"></div>

    <script>
        const types = {
            "success": {
                "icon": "check_circle",
                "title": "Succès"
            },
            "error": {
                "icon": "cancel",
                "title": "Erreur"
            },
            "info": {
                "icon": "info",
                "title": "Info"
            },
            "warning": {
                "icon": "error",
                "title": "Avertissement"
            }
        }

        const toasts = {
            "save": {
                "type": "success",
                "message": "Les données ont bien été enregistrées."
            },
            "delete": {
                "type": "success",
                "message": "Les données ont bien été supprimées."
            },
            "error-empty-category": {
                "type": "error",
                "message": "Il y a 1 catégorie qui ne possède pas de nom."
            },
            "error-empty-categories": {
                "type": "error",
                "message": "Il y a {nb} catégories qui ne possèdent pas de nom."
            },
            "error-not-enough-days": {
                "type": "error",
                "message": "Vous ne disposez plus de jours de congés pour la catégorie : {congeActif}."
            },
            "info-reached-days": {
                "type": "info",
                "message": "Vous venez d'atteindre votre nombre de jours de congés maximum pour la catégorie : {congeActif}."
            }
        };

        function addToast(toastType, variable = {}) {
            const wrapper = document.querySelector(".wrapper");

            const type = toasts[toastType]["type"];
            let message = toasts[toastType]["message"];
            const icon = types[type]["icon"];
            const title = types[type]["title"];

            if (Object.keys(variable).length > 0) {
                Object.keys(variable).forEach(v => {
                    message = message.replace(`{${v}}`, variable[v]);
                });
            }

            const toast = document.createElement("div");
            toast.classList.add("toast");
            toast.classList.add(type);
            toast.innerHTML = `
                <div class="container-1">
                    <span class="material-symbols-outlined">${icon}</span>
                </div>
                <div class="container-2">
                    <p>${title}</p>
                    <p>${message}</p>
                </div>
                <button class="toast-button" onclick="deleteToast(this)">&times;</button>
            `;

            wrapper.prepend(toast);

            if (type !== "error") {
                setTimeout(() => {
                    toast.style.opacity = "0";
                    setTimeout(() => toast.remove(), 500);
                }, 3000);
            }
        }

        function deleteToast(button) {
            const toast = button.closest(".toast");
            toast.style.opacity = "0";
            setTimeout(() => toast.remove(), 500);
        }

        let year = "";

        let isDrawing = false;

        let congeActif = "";

        let dicoConge = {};

        function generateColor() {
            function randomHexColor() {
                return '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');
            }

            function isForbiddenColor(hex) {
                // Convertir hex en RGB
                const rgb = parseInt(hex.slice(1), 16);
                const r = (rgb >> 16) & 0xff;
                const g = (rgb >> 8) & 0xff;
                const b = rgb & 0xff;

                // Vérifier si la couleur est dans les tons gris (valeurs R, G, B proches)
                const isGray = Math.abs(r - g) < 30 && Math.abs(g - b) < 30 && Math.abs(r - b) < 30;

                // Vérifier si la couleur est verte (G dominant)
                const isGreen = g > r && g > b;

                // Vérifier si la couleur est blanche (toutes les composantes proches de 255)
                const isWhite = r > 230 && g > 230 && b > 230;

                // Vérifier si la couleur est orange (R élevé, G modéré, B faible)
                const isOrange = r > 180 && g > 100 && b < 50;

                return isGray || isGreen || isWhite || isOrange;
            }

            let newColor;
            do {
                newColor = randomHexColor();
            } while (Object.values(dicoConge).includes(newColor) || isForbiddenColor(newColor));

            return newColor.toUpperCase();
        }

        function addCategory1(conge, nb, color) {
            // Ajout de la categorie dans le summary
            const tBody = document.querySelector("tbody");
            const tr = document.createElement("tr");
            tr.id = "category";

            tr.innerHTML = `
                <td class="noBorder">
                    <button class="delete-category" onclick="deleteCategory(this)" title="Supprimer la catégorie ainsi que les jours posés dans le calendrier">
                        <span class="material-symbols-outlined">do_not_disturb_on</span>Catégorie
                    </button>
                    <button class="edit-category" onclick="updateCategory(this)" title="Modifier le nom de la catégorie">
                        <span class="material-symbols-outlined">edit</span>Catégorie
                    </button>
                </td>
                <th>
                    <span id="span">${conge}</span>&nbsp;
                    <input id="category-color" type="color" value="${color}" onchange="setCongeColor(this)" title="Modifier la couleur de la catégorie">
                </th>
                <td><input value="${nb}" type="number" id="total${conge}" min="0" max="50" onchange="updateSummary()"></td>
                <td id="used${conge}">0</td>
                <td id="remaining${conge}">0</td>
                <td class="noBorder">
                    <button class="delete-category-days" onclick="deleteCongeCategory(this)" title="Supprimer les jours posés dans le calendrier appartenant à cette catégorie">
                        <span class="material-symbols-outlined">ink_eraser</span>Congés
                    </button>
                </td>
            `;

            tBody.insertBefore(tr, tBody.children[tBody.children.length - 1]);
        }

        function addCategory() {
            // Ajout de la categorie dans le summary
            const tBody = document.querySelector("tbody");
            const tr = document.createElement("tr");
            tr.id = "category";
            const color = generateColor();

            tr.innerHTML = `
                <td class="noBorder">
                    <button class="delete-category" onclick="deleteCategory(this)" title="Supprimer la catégorie ainsi que les jours posés dans le calendrier">
                        <span class="material-symbols-outlined">do_not_disturb_on</span>Catégorie
                    </button>
                    <button class="edit-category" onclick="updateCategory(this)" title="Modifier le nom de la catégorie">
                        <span class="material-symbols-outlined">edit</span>Catégorie
                    </button>
                </td>
                <th>
                    <span id="span"></span>&nbsp;
                    <input id="category-color" type="color" value="${color}" onchange="setCongeColor(this)" title="Modifier la couleur de la catégorie">
                </th>
                <td><input value="0" type="number" id="total" min="0" max="50" onchange="updateSummary()"></td>
                <td id="used">0</td>
                <td id="remaining">0</td>
                <td class="noBorder">
                    <button class="delete-category-days" onclick="deleteCongeCategory(this)" title="Supprimer les jours posés dans le calendrier appartenant à cette catégorie">
                        <span class="material-symbols-outlined">ink_eraser</span>Congés
                    </button>
                </td>
            `;

            tBody.insertBefore(tr, tBody.children[tBody.children.length - 1]);
            updateCategory(tr.querySelectorAll("button")[1]);
        }

        function setCongeColor(input) {
            const th = input.closest("th");
            const conge = th.querySelector("span").innerText;
            dicoConge[conge] = input.value;
            createStyle(conge, dicoConge[conge]);
        }

        function createStyle(value, color) {
            const sheet = document.styleSheets[1];
            sheet.insertRule(`.${value} { background-color: ${color}; }`, sheet.cssRules.length);
        }

        function updateCategory(button) {
            const tr = button.closest("tr");
            
            const span = tr.querySelector("#span");

            let valeurActuelle = span.innerHTML.trim().length != 0 ? span.innerText.trim() : "";
            let input = document.createElement("input");
            input.type = "text";
            input.value = valeurActuelle;

            input.onblur = function(event) {
                updateCategoryFactorized(event, input, span, tr, valeurActuelle);
            };
            input.onkeypress = function(event) {
                if (event.key === "Enter") {
                    updateCategoryFactorized(event, input, span, tr, valeurActuelle);
                }
            };

            span.innerHTML = "";
            span.appendChild(input);
            input.focus();
        }

        function updateCategoryFactorized(event, input, span, tr, valeurActuelle) {
            let newValue = input.value.trim().toUpperCase();
            if (valeurActuelle !== newValue) {
                if (!checkCongeValide(newValue)) event.target.focus();
                else {
                    // Mise a jour de la ligne associe au conge
                    newValue = newValue.trim();
                    span.innerText = newValue;
                    tr.querySelectorAll("td")[1].querySelector("input").id = `total${newValue}`;
                    tr.querySelectorAll("td")[2].id = `used${newValue}`;
                    tr.querySelectorAll("td")[3].id = `remaining${newValue}`;
                    
                    // Ajout de la couleur dans le dico et creation du style
                    const color = tr.querySelector("th").querySelector("input").value.toUpperCase();
                    dicoConge[newValue] = color;
                    createStyle(newValue, color);

                    // On regarde si on doit supprimer l'ancienne valeur du conge au dessus du calendrier
                    // et si on doit ajouter la nouvelle valeur
                    const selection = document.querySelector(".selection");
                    let eltToDelete;
                    let addElement = true;
                    Array.from(selection.children).forEach(elt => {
                        if (valeurActuelle.length != 0) {
                            if (elt.id.split("top")[1] === valeurActuelle) {
                                eltToDelete = elt;
                            }
                        }
                        if (elt.id.split("top")[1] === newValue) {
                            addElement = false;
                        }
                    });
                    // console.log(addElement);

                    // On supprime l'ancien element si on l'a trouve ainsi que dans le dictionnaire des conges
                    if (eltToDelete) {
                        selection.removeChild(eltToDelete);
                        delete dicoConge[eltToDelete.id.split("top")[1]];
                    }

                    // On ajoute le nouvel element
                    if (addElement) {
                        const conge = document.createElement("div");
                        conge.classList.add("selectionConge");
                        conge.id = `top${newValue}`;
                        conge.innerText = newValue;
                        conge.addEventListener("click", function () {
                            setCongeActif(this);
                        });
                        selection.appendChild(conge);
                    }
                }
            }
            else {
                span.innerText = valeurActuelle;
            }
        }

        function checkCongeValide(newValue) {
            if (!newValue || newValue.length === 0) return false;
            for (let conge of getCongesList()) {
                if (conge === newValue) {
                    return false;
                }
            }
            return true;
        }

        function deleteCategory(button) {
            const tr = button.closest("tr");
            const conge = tr.querySelector("#span").innerText;
            
            // Supprimer le conge dans le dictionnaire
            delete dicoConge[conge];

            // Remettre a "" le congeActif s'il est selectionne
            congeActif = congeActif === conge ? "" : congeActif;
            
            // Supprimer l'element au dessus du calendrier
            const selection = document.querySelector(".selection");
            let eltToDelete;
            Array.from(selection.children).forEach(elt => {
                if (elt.id.split("top")[1] === conge) eltToDelete = elt;
            });
            if (eltToDelete) selection.removeChild(eltToDelete);

            // Supprimer la ligne du tableau Summary
            const tbody = document.querySelector("tbody");
            tbody.removeChild(tr);

            // Supprimer les jours dans le calendrier
            document.querySelectorAll(`.${conge}`).forEach(elt => {
                elt.classList = "day";
            });

            // Mettre a jour le tableau Summary
            updateSummary();

            // Supprimer le style
            const sheet = document.styleSheets[1];
            for (let i = 0; i < sheet.cssRules.length; i++) {
                if (sheet.cssRules[i].selectorText === `.${conge}`) {
                    sheet.deleteRule(i);
                    break;
                }
            }
        }

        function changeYear() {
            year = document.getElementById("year").value;
        }

        function changeYearValue() {
            const [daysCalendar, daysSummary, dicoActual] = getActualAndStockage();

            if (!(checkDictionnariesEqual(dicoActual["conges"], daysCalendar) && checkDictionnariesEqual(dicoActual["summary"], daysSummary))) {
                showCustomConfirm(function(save) {
                    if (save) {
                        saveYear();
                    }
                    generateSummary();
                });
            }
            else generateSummary();
        }

        // function checkIfDataToSave() {
        //     const [daysCalendar, daysSummary, dicoActual] = getActualAndStockage();

        //     if (!(checkDictionnariesEqual(dicoActual["conges"], daysCalendar) && checkDictionnariesEqual(dicoActual["summary"], daysSummary))) {
        //         showCustomConfirm(function(save) {
        //             if (save) {
        //                 saveYear();
        //             }
        //         });
        //     }
        // }

        function showCustomConfirm(callback) {
            const modal = document.getElementById("customConfirm");
            modal.style.display = "flex";

            window.confirmSave = function (save) {
                modal.style.display = "none";
                callback(save);
            };
        }

        // function closeCustomConfirm() {
        //     document.getElementById("customConfirm").style.display = "none";
        // }

        function setCongeActif(elt) {
            const congeId = elt.id.split("top").join("");
            const currentColor = rgbToHex(elt.style.backgroundColor);

            if (currentColor === dicoConge[congeId]) { elt.style.backgroundColor = ""; congeActif = ""; }
            else { elt.style.backgroundColor = dicoConge[congeId]; congeActif = congeId; }
            
            document.querySelectorAll("[id^='top']").forEach(conge => {
                const id = conge.id.split("top").join("");
                if (id !== congeId) conge.style.backgroundColor = "";
            });
        }

        function rgbToHex(rgb) {
            const result = /^rgb\((\d+), (\d+), (\d+)\)$/.exec(rgb);
            if (!result) return null;

            return `#${(
                1 << 24 |
                (parseInt(result[1]) << 16) |
                (parseInt(result[2]) << 8) |
                parseInt(result[3])
            ).toString(16).slice(1).toUpperCase()}`;
        }

        function setCongeDay(cell) {
            if (congeActif !== "") {
                let error = false;
                document.querySelectorAll("#category").forEach(elt => {
                    if (elt.querySelector("#span").innerText === congeActif && !cell.classList.contains(congeActif)) {
                        if (elt.querySelector(`#remaining${congeActif}`).innerText === "0") error = true;
                    }
                });

                if (error) {
                    addToast("error-not-enough-days", { congeActif: congeActif });
                    document.dispatchEvent(new Event("mouseup"));
                    return;
                }
                else {
                    if (cell.classList.contains(congeActif)) cell.classList.remove(congeActif);
                    else {
                        cell.classList = "day";
                        cell.classList.add(congeActif);
                    }
                    updateSummary();

                    if (document.querySelector(`#remaining${congeActif}`).innerText === "0") {
                        addToast("info-reached-days", { congeActif: congeActif });
                    }
                }
            }
        }

        function deleteCongeCategory(button) {
            const tr = button.closest("tr");
            const conge = tr.querySelector("#span").innerText;
            
            document.querySelectorAll(`.${conge}`).forEach(elt => {
                elt.classList = "day";
            });
            updateSummary();
        }

        function getEasterDate(year) {
            let a = year % 19;
            let b = Math.floor(year / 100);
            let c = year % 100;
            let d = Math.floor(b / 4);
            let e = b % 4;
            let f = Math.floor((b + 8) / 25);
            let g = Math.floor((b - f + 1) / 3);
            let h = (19 * a + b - d - g + 15) % 30;
            let i = Math.floor(c / 4);
            let k = c % 4;
            let l = (32 + 2 * e + 2 * i - h - k) % 7;
            let m = Math.floor((a + 11 * h + 22 * l) / 451);
            let month = Math.floor((h + l - 7 * m + 114) / 31);
            let day = ((h + l - 7 * m + 114) % 31) + 1;
            return new Date(year, month - 1, day);
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function getLundiPaques(year) {
            let easter = getEasterDate(year);
            let lundiPaques = new Date(easter);
            lundiPaques.setDate(easter.getDate() + 1);
            return lundiPaques;
        }

        function getJeudiAscension(year) {
            let easter = getEasterDate(year);
            let jeudiAscension = new Date(easter);
            jeudiAscension.setDate(easter.getDate() + 39);
            return jeudiAscension;
        }

        function getLundiPentecote(year) {
            let easter = getEasterDate(year);
            let lundiPentecote = new Date(easter);
            lundiPentecote.setDate(easter.getDate() + 50);
            return lundiPentecote;
        }

        function getRealDay(day) {
            return (day + 6) % 7;
        }

        function generateCalendar() {
            document.getElementById("calendar").innerHTML = "";

            let dicoDays = {};
            let dico = JSON.parse(localStorage.getItem(year.toString())) || {};
            if (Object.keys(dico).includes("conges")) {
                if (Object.keys(dico["conges"]).length > 0) dicoDays = dico["conges"];
            }

            const holidays = [
                formatDate(new Date(year, 0, 1)),       // 1er Janvier
                formatDate(new Date(year, 4, 1)),       // 1er Mai
                formatDate(new Date(year, 4, 8)),       // 8 Mai
                formatDate(new Date(year, 6, 14)),      // 14 Juillet
                formatDate(new Date(year, 7, 15)),      // 15 Août
                formatDate(new Date(year, 10, 11)),     // 11 Novembre
                formatDate(new Date(year, 11, 25)),     // 25 Décembre
                formatDate(getLundiPaques(year)),       // Lundi de Paques
                formatDate(getJeudiAscension(year)),    // Jeudi de l'Ascension
                formatDate(getLundiPentecote(year))     // Lundi de Pentecote
            ];

            const calendar = document.getElementById("calendar");
            calendar.innerHTML = "";
            const monthNames = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
            const dayNames = ["L", "M", "M", "J", "V", "S", "D"];

            for (let month = 0; month < 12; month++) {
                let monthDiv = document.createElement("div");
                monthDiv.className = "month";
                monthDiv.innerHTML = `<div class='month-title'>${monthNames[month]}</div>`;
                
                let dayTable = document.createElement("table");
                dayTable.classList.add("dayTable");
                for (let day = 1; day <= 31; day++) {
                    let dayTr = document.createElement("tr");
                    let stringDay = `${year}-${month + 1}-${day}`;
                    
                    let test = false;
                    let congeTmp;
                    if (Object.keys(dicoDays).length > 0) {
                        for (let conge of getCongesList()) {
                            if (dicoDays[conge].includes(stringDay)) {
                                test = true;
                                congeTmp = conge;
                            }
                        }
                    }
                    if (test) dayTr.classList = `day ${congeTmp}`;
                    else dayTr.className = "day";
                    dayTr.id = stringDay;

                    let date = new Date(year, month, day);
                    if (date.getMonth() !== month) break;
                    
                    let dayOfWeek = dayNames[getRealDay(date.getDay())];

                    let dayNumber = document.createElement("td");
                    dayNumber.classList.add("number");
                    dayNumber.innerText = `${dayOfWeek}`;

                    let dayLetter = document.createElement("td");
                    dayLetter.classList.add("letter");
                    dayLetter.innerText = `${day}`;

                    dayTr.appendChild(dayNumber);
                    dayTr.appendChild(dayLetter);
                    
                    if (getRealDay(date.getDay()) === 5 || getRealDay(date.getDay()) === 6) dayTr.classList.add("weekend");
                    if (holidays.includes(date.toISOString().split('T')[0])) dayTr.classList.add("holiday");

                    if (!dayTr.classList.contains("weekend") && !dayTr.classList.contains("holiday")) {
                        let td = document.createElement("td");
                        dayTr.addEventListener("mousedown", function(event) {
                            isDrawing = true;
                            setCongeDay(this);
                            event.preventDefault();
                        });
                        dayTr.addEventListener("mouseenter", function() {
                            if (isDrawing) { setCongeDay(this); }
                        });
                        dayTr.appendChild(td);
                    }
                    dayTable.appendChild(dayTr);
                    monthDiv.appendChild(dayTable);
                }
                calendar.appendChild(monthDiv);
            }
            updateSummary();
        }

        function generateSummary() {
            let [error, nb] = checkErrorConge();
            if (error) {
                document.getElementById("year").value = document.getElementById("year").dataset.oldValue;
                if (nb === 1) addToast("error-empty-category");
                else addToast("error-empty-categories", { nb: nb });
            }
            else {
                document.getElementById("year").dataset.oldValue = document.getElementById("year").value;
                changeYear();

                document.querySelectorAll("#category").forEach(cat => {
                    deleteCategory(cat.querySelector("button.delete-category"));
                });

                dicoConge = {};

                let dicoSummary = {};
                let dico = JSON.parse(localStorage.getItem(year.toString())) || {};
                if (Object.keys(dico).includes("summary")) {
                    if (Object.keys(dico["summary"]).length > 0) dicoSummary = dico["summary"];
                }

                Object.keys(dicoSummary).forEach(elt => {
                    dicoConge[elt] = dicoSummary[elt][1].toUpperCase();
                    createStyle(elt, dicoSummary[elt][1].toUpperCase());
                });
                
                if (Object.keys(dicoSummary).length !== 0) {
                    // On ajoute les categories dans le tableau et au dessus du calendrier
                    for (let conge of getCongesList()) {
                        if (Object.keys(dicoSummary).includes(conge)) {
                            addCategory1(conge, dicoSummary[conge][0], dicoSummary[conge][1]);
                            const selection = document.querySelector(".selection");
                            // On ajoute le nouvel element
                            const congeElt = document.createElement("div");
                            congeElt.classList.add("selectionConge");
                            congeElt.id = `top${conge}`;
                            congeElt.innerText = conge;
                            congeElt.addEventListener("click", function () {
                                setCongeActif(this);
                            });
                            selection.appendChild(congeElt);
                        }
                        else {
                            document.querySelector(`input#total${conge}`).value = "0";
                        }
                    }
                }

                generateCalendar();
            }
        }

        function updateSummary() {
            let totalTotal = 0;
            document.querySelectorAll("input[id^='total']").forEach(elt => {
                totalTotal += parseInt(elt.value);
            });
            document.getElementById("totalAll").innerText = totalTotal;

            let totalSum = 0;
            for (let conge of getCongesList()) {
                let totalConge = document.querySelectorAll(`.${conge}`).length;
                document.getElementById(`used${conge}`).innerText = totalConge;
                totalSum += totalConge;
                document.getElementById(`remaining${conge}`).innerText = parseInt(document.getElementById(`total${conge}`).value) - totalConge;
            }
            document.getElementById("usedAll").innerText = totalSum;
            document.getElementById("remainingAll").innerText = document.getElementById("totalAll").innerText - totalSum;
        }

        function saveYear() {
            let [error, nb] = checkErrorConge();

            if (error) {
                if (nb === 1) addToast("error-empty-category");
                else addToast("error-empty-categories", { nb: nb });
            }
            else {
                const [daysCalendar, daysSummary, dico] = getActualAndStockage();

                console.log(daysCalendar);
                console.log(daysSummary);
                console.log(dico);
                
                dico["conges"] = daysCalendar;
                dico["summary"] = daysSummary;
                localStorage.setItem(year, JSON.stringify(dico));

                addToast("save");
            }
        }

        function deleteYear() {
            for(let conge of getCongesList()) {
                document.querySelectorAll(`.${conge}`).forEach(elt => {
                    elt.classList = "day";
                });
            }

            let dico = JSON.parse(localStorage.getItem(year.toString())) || {};
            dico["conges"] = {};
            localStorage.setItem(year, JSON.stringify(dico));

            updateSummary();

            addToast("delete");
        }

        function getCongesList() {
            return Object.keys(dicoConge);
        }

        function checkErrorConge() {
            let error = false;
            let nb = 0;
            document.querySelectorAll("#category").forEach(cat => {
                if (cat.querySelector("#span").innerText.length === 0) { error = true; nb++; }
            });
            return [error, nb];
        }

        function storeOldValue(input) {
            input.dataset.oldValue = input.value;
        }

        function setDate() {
            document.getElementById("year").value = new Date().getFullYear();
            document.getElementById("year").dataset.oldValue = document.getElementById("year").value;
            changeYear();
        }

        setDate();

        generateSummary();

        function getActualAndStockage() {
            let daysCalendar = {};
            let daysSummary = {};
            for (let conge of getCongesList()) {
                daysCalendar[conge] = [];
                document.querySelectorAll(`.${conge}`).forEach(elt => {
                    daysCalendar[conge].push(elt.id);
                });

                daysSummary[conge] = [];
                document.querySelectorAll(`#total${conge}`).forEach(elt => {
                    daysSummary[conge].push(elt.value);
                    daysSummary[conge].push(elt.closest("tr").children[1].children[1].value);
                });
            }

            let dico = JSON.parse(localStorage.getItem(year.toString())) || {"conges": {}, "summary": {}};
            
            return [daysCalendar, daysSummary, dico];
        }

        function checkDictionnariesEqual(dict1, dict2) {
            let keys1 = Object.keys(dict1);
            let keys2 = Object.keys(dict2);

            if (keys1.length !== keys2.length) return false;

            return keys1.every(key => {
                if (!dict2.hasOwnProperty(key)) return false;

                let list1 = [...dict1[key]].sort();
                let list2 = [...dict2[key]].sort();

                return list1.length === list2.length && list1.every((value, index) => value === list2[index]);
            });
        }

        document.addEventListener("mouseup", () => {
            isDrawing = false;
        });

        // document.addEventListener("keydown", function (event) {
        //     if (event.key === "Escape") {
        //         closeCustomConfirm();
        //     }
        // });
    </script>
</body>
</html>
